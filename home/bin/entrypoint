#!/usr/bin/env sh
## Entrypoint Script

set -e

## Set environment.
CMD="lnd"
DATA="/root/.lnd"
CONF="/config/lnd.conf"
LOG_FILE="$DATA/start.log"
COOKIE_FILE="$DATA/.cookie"

## Ensure bin files are executable.
for FILE in $PWD/bin/* ; do chmod a+x $FILE; done

## Format variables if set.
if [ -n "$WALLET_PW" ]; then
  printf "$WALLET_PW" > $COOKIE_FILE
  WALLET_CONF="--wallet-unlock-password-file=$COOKIE_FILE"
fi

## Check if binary exists.
[ -z "$(which $CMD)" ] && (echo "$CMD file is missing!" && exit 1)

## Construct params string.
PARAMS="\
--bitcoin.active \
--bitcoin.$NETWORK \
--bitcoin.node=neutrino \
--configfile=$CONF \
$WALLET_CONF $@"

## Execute main binary.
printf "[ $(date "+%D | %r") ]\nExecuting $CMD with params:\n" > $LOG_FILE
for param in $PARAMS; do echo $param >> $LOG_FILE; done && echo

$CMD $PARAMS
